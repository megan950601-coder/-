<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¬ æ¬¾è¨˜å¸³ï½œIOU Ledger</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#121a2a;
      --card2:#0f1626;
      --text:#e7eefc;
      --muted:#a9b6d6;
      --line:#25314d;
      --good:#4ade80;
      --bad:#fb7185;
      --warn:#fbbf24;
      --btn:#3b82f6;
      --btn2:#1f2937;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
      background: radial-gradient(1200px 800px at 20% 0%, #172554 0%, var(--bg) 50%, #050814 100%);
      color:var(--text);
    }
    .app{
      max-width: 460px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 18px 14px 92px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom: 14px;
    }
    .title{
      font-weight: 800;
      letter-spacing: .3px;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      font-size: 12px;
      padding: 4px 8px;
      background: rgba(59,130,246,.18);
      border: 1px solid rgba(59,130,246,.35);
      color: #b7d1ff;
      border-radius: 999px;
    }
    .iconbtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.2);
    }
    .iconbtn:active{transform: translateY(1px)}
    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(37,49,77,.9);
      border-radius: var(--radius);
      padding: 14px 14px;
      box-shadow: var(--shadow);
    }
    .card h3{
      margin: 0 0 8px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing:.2px;
    }
    .money{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .money.good{color: var(--good)}
    .money.bad{color: var(--bad)}
    .search{
      margin: 10px 0 12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input{
      width: 100%;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
    }
    .input::placeholder{color:#7f8db2}
    .list{
      background: rgba(255,255,255,.02);
      border:1px solid rgba(37,49,77,.8);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .row{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-top: 1px solid rgba(37,49,77,.7);
      cursor:pointer;
    }
    .row:first-child{border-top:none}
    .row:active{background: rgba(255,255,255,.03)}
    .row .name{
      font-weight: 800;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .row .sub{
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }
    .pill{
      font-weight: 900;
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(37,49,77,.9);
      background: rgba(255,255,255,.02);
      min-width: 110px;
      text-align:right;
    }
    .pill.good{color: var(--good)}
    .pill.bad{color: var(--bad)}
    .fab{
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(59,130,246,1), rgba(37,99,235,1));
      color: white;
      border: none;
      font-size: 28px;
      font-weight: 900;
      box-shadow: 0 18px 35px rgba(59,130,246,.35);
      cursor:pointer;
    }
    .fab:active{transform: translateY(1px)}
    .nav{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      width: min(460px, calc(100% - 28px));
      display:flex;
      gap:10px;
      padding: 10px;
      border-radius: 18px;
      border:1px solid rgba(37,49,77,.9);
      background: rgba(18,26,42,.85);
      backdrop-filter: blur(8px);
    }
    .nav button{
      flex:1;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(37,49,77,.9);
      background: rgba(255,255,255,.02);
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
    }
    .nav button.active{
      background: rgba(59,130,246,.20);
      border-color: rgba(59,130,246,.40);
      color:#cfe1ff;
    }
    /* Modal */
    .modal{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .sheet{
      width: min(460px, 100%);
      background: linear-gradient(180deg, rgba(18,26,42,1), rgba(15,22,38,1));
      border:1px solid rgba(37,49,77,.95);
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .sheet header{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(37,49,77,.75);
    }
    .sheet header h2{
      margin:0;
      font-size: 15px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .sheet header .x{
      border:none;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(37,49,77,.9);
      color: var(--text);
      width: 38px;
      height: 38px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
    }
    .sheet .content{
      padding: 14px;
      max-height: 72vh;
      overflow:auto;
    }
    .grid{
      display:grid;
      gap:10px;
    }
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      display:block;
      margin: 0 0 6px;
    }
    .select{
      width: 100%;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
    }
    .btnrow{
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }
    .btn{
      flex:1;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(37,49,77,.9);
      background: rgba(255,255,255,.02);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
    }
    .btn.primary{
      background: rgba(59,130,246,.22);
      border-color: rgba(59,130,246,.45);
      color: #d7e7ff;
    }
    .btn.danger{
      background: rgba(251,113,133,.15);
      border-color: rgba(251,113,133,.35);
      color: #ffd2da;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
      margin-top: 8px;
    }
    .splitTable{
      margin-top: 10px;
      border:1px solid rgba(37,49,77,.8);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .splitRow{
      display:grid;
      grid-template-columns: 1.3fr 1fr 42px;
      gap: 10px;
      padding: 10px;
      border-top: 1px solid rgba(37,49,77,.7);
      align-items:center;
    }
    .splitRow:first-child{border-top:none}
    .smallbtn{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border:1px solid rgba(37,49,77,.9);
      background: rgba(255,255,255,.02);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
    }
    .tag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size: 12px;
      color: #cfe1ff;
      border:1px solid rgba(59,130,246,.35);
      background: rgba(59,130,246,.14);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      margin: 8px 0 0;
    }
    .ledgerHeader{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-bottom: 10px;
    }
    .ledgerTitle{
      font-size: 16px;
      font-weight: 950;
    }
    .ledgerBalance{
      font-size: 18px;
      font-weight: 950;
    }
    .ledgerBalance.good{color: var(--good)}
    .ledgerBalance.bad{color: var(--bad)}
    .tx{
      padding: 12px 14px;
      border-top: 1px solid rgba(37,49,77,.7);
    }
    .tx:first-child{border-top:none}
    .txTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
    }
    .txName{
      font-weight: 900;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .txMeta{font-size: 12px; color: var(--muted); font-weight: 700}
    .txAmt{
      font-weight: 950;
      text-align:right;
      min-width: 110px;
    }
    .txAmt.good{color: var(--good)}
    .txAmt.bad{color: var(--bad)}
    .txNote{
      margin-top: 6px;
      font-size: 12px;
      color: #c7d2fe;
      opacity:.95;
    }
    .txActions{
      margin-top: 10px;
      display:flex;
      gap: 10px;
    }
    .tiny{
      flex: 0 0 auto;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(37,49,77,.9);
      background: rgba(255,255,255,.02);
      color: var(--text);
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 88px;
      z-index: 60;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(37,49,77,.95);
      background: rgba(18,26,42,.92);
      color: var(--text);
      font-weight: 800;
      font-size: 13px;
      box-shadow: 0 20px 50px rgba(0,0,0,.5);
      display:none;
    }
    .muted{color: var(--muted)}
    .warn{color: var(--warn)}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="title">æ¬ æ¬¾è¨˜å¸³ <span class="badge">IOU</span></div>
      <button class="iconbtn" id="btnReset" title="æ¸…ç©ºè³‡æ–™">é‡ç½®</button>
    </div>

    <div id="viewDashboard">
      <div class="cards">
        <div class="card">
          <h3>åˆ¥äººæ¬ æˆ‘</h3>
          <div class="money good" id="sumOwedToMe">NT$ 0.00</div>
          <div class="hint">ï¼ˆæ‰€æœ‰ balance &gt; 0 åŠ ç¸½ï¼‰</div>
        </div>
        <div class="card">
          <h3>æˆ‘æ¬ åˆ¥äºº</h3>
          <div class="money bad" id="sumIOwe">NT$ 0.00</div>
          <div class="hint">ï¼ˆæ‰€æœ‰ balance &lt; 0 çµ•å°å€¼åŠ ç¸½ï¼‰</div>
        </div>
      </div>

      <div class="search">
        <input class="input" id="searchPeople" placeholder="æœå°‹äººåâ€¦ ä¾‹å¦‚ï¼šé˜¿æ˜" />
        <button class="iconbtn" id="btnAddPerson" title="æ–°å¢äºº">ï¼‹äºº</button>
      </div>

      <div class="list" id="peopleList"></div>
      <div class="hint muted" style="margin-top:10px">
        å°æç¤ºï¼šbalance &gt; 0 ä»£è¡¨ã€Œä»–æ¬ ä½ ã€ï¼Œbalance &lt; 0 ä»£è¡¨ã€Œä½ æ¬ ä»–ã€(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§
      </div>
    </div>

    <div id="viewLedger" style="display:none;">
      <button class="iconbtn" id="btnBack">â† è¿”å›</button>
      <div class="card" style="margin-top:12px;">
        <div class="ledgerHeader">
          <div class="ledgerTitle" id="ledgerName">â€”</div>
          <div class="ledgerBalance" id="ledgerBalance">â€”</div>
          <div class="tag" id="ledgerTag" style="display:none;"></div>
        </div>
        <div class="btnrow">
          <button class="btn primary" id="btnQuickLend">ä»–æ¬ æˆ‘</button>
          <button class="btn primary" id="btnQuickBorrow">æˆ‘æ¬ ä»–</button>
        </div>
        <div class="btnrow">
          <button class="btn" id="btnQuickRepayToMe">ä»–é‚„æˆ‘</button>
          <button class="btn" id="btnQuickRepayByMe">æˆ‘é‚„ä»–</button>
        </div>
        <div class="hint">ä½ ä¹Ÿå¯ä»¥ç”¨ã€Œï¼‹ã€åšå¤šäººåˆ†å¸³ï¼ˆä½ ä»£å¢Š â†’ å¤šäººæ¬ ä½ ï¼‰ã€‚</div>
      </div>

      <div class="list" id="txList" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div class="nav">
    <button id="navHome" class="active">ç¸½è¦½</button>
    <button id="navAdd">æ–°å¢åˆ†å¸³</button>
  </div>
  <button class="fab" id="fab">ï¼‹</button>

  <!-- Modal: Add Person -->
  <div class="modal" id="modalPerson">
    <div class="sheet">
      <header>
        <h2>æ–°å¢äºº</h2>
        <button class="x" data-close="modalPerson">âœ•</button>
      </header>
      <div class="content">
        <div class="grid">
          <div>
            <label>äººå</label>
            <input class="input" id="personName" placeholder="ä¾‹å¦‚ï¼šé˜¿æ˜" />
            <div class="hint">äººåé‡è¤‡æœƒè‡ªå‹•åˆä½µåˆ°åŒä¸€äººï¼ˆç”¨åŒåè¦–ç‚ºåŒä¸€äººï¼‰</div>
          </div>
          <div class="btnrow">
            <button class="btn" data-close="modalPerson">å–æ¶ˆ</button>
            <button class="btn primary" id="savePerson">æ–°å¢</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add Split (group lend only) -->
  <div class="modal" id="modalSplit">
    <div class="sheet">
      <header>
        <h2>æ–°å¢åˆ†å¸³ï¼ˆä½ ä»£å¢Š â†’ ä»–å€‘æ¬ ä½ ï¼‰</h2>
        <button class="x" data-close="modalSplit">âœ•</button>
      </header>
      <div class="content">
        <div class="grid">
          <div class="two">
            <div>
              <label>ç¾¤çµ„åç¨±</label>
              <input class="input" id="splitTitle" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ / é£²æ–™" />
            </div>
            <div>
              <label>æ—¥æœŸ</label>
              <input class="input" id="splitDate" type="date" />
            </div>
          </div>
          <div>
            <label>å‚™è¨»ï¼ˆå¯ç©ºï¼‰</label>
            <input class="input" id="splitNote" placeholder="ä¾‹å¦‚ï¼šåœ¨XXåƒé£¯" />
          </div>

          <div>
            <label>åˆ†å¸³æ¸…å–®ï¼ˆæ¯äººå„è‡ªè¼¸å…¥é‡‘é¡ï¼Œå¯å°æ•¸ï¼‰</label>
            <div class="splitTable" id="splitTable"></div>
            <div class="btnrow">
              <button class="btn" id="addSplitRow">ï¼‹æ–°å¢ä¸€åˆ—</button>
              <button class="btn" id="add3Rows">ï¼‹ï¼‹ä¸‰åˆ—</button>
            </div>
            <div class="hint">é‡‘é¡å»ºè­°è¼¸å…¥åˆ°å°æ•¸é»å¾Œå…©ä½ï¼ˆä¾‹å¦‚ 99.50ï¼‰ã€‚</div>
          </div>

          <div class="card" style="background:rgba(255,255,255,.02); box-shadow:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
              <div class="muted" style="font-weight:800;">åˆè¨ˆï¼ˆæ‰€æœ‰åˆ—é‡‘é¡åŠ ç¸½ï¼‰</div>
              <div class="money" id="splitTotal">NT$ 0.00</div>
            </div>
            <div class="hint">é€å‡ºå¾Œæœƒè‡ªå‹•æ‹†æˆå¤šç­†ã€Œä»–æ¬ æˆ‘ã€äº¤æ˜“ä¸¦æ›´æ–°æ¯å€‹äººçš„é¤˜é¡ã€‚</div>
          </div>

          <div class="btnrow">
            <button class="btn" data-close="modalSplit">å–æ¶ˆ</button>
            <button class="btn primary" id="saveSplit">ç¢ºèªæ–°å¢</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Quick Tx (single person) -->
  <div class="modal" id="modalQuickTx">
    <div class="sheet">
      <header>
        <h2 id="quickTitle">æ–°å¢ç´€éŒ„</h2>
        <button class="x" data-close="modalQuickTx">âœ•</button>
      </header>
      <div class="content">
        <div class="grid">
          <div class="two">
            <div>
              <label>äºº</label>
              <select class="select" id="quickPerson"></select>
            </div>
            <div>
              <label>æ—¥æœŸ</label>
              <input class="input" id="quickDate" type="date" />
            </div>
          </div>
          <div class="two">
            <div>
              <label>é¡å‹</label>
              <select class="select" id="quickType">
                <option value="lend">ä»–æ¬ æˆ‘ï¼ˆä½ å€Ÿ/ä½ ä»£å¢Šï¼‰</option>
                <option value="borrow">æˆ‘æ¬ ä»–ï¼ˆä½ å€ŸéŒ¢/ä»–ä»£å¢Šï¼‰</option>
                <option value="repay_to_me">ä»–é‚„æˆ‘</option>
                <option value="repay_by_me">æˆ‘é‚„ä»–</option>
              </select>
            </div>
            <div>
              <label>é‡‘é¡</label>
              <input class="input" id="quickAmount" inputmode="decimal" placeholder="ä¾‹å¦‚ 120.50" />
            </div>
          </div>
          <div>
            <label>å‚™è¨»ï¼ˆå¯ç©ºï¼‰</label>
            <input class="input" id="quickNote" placeholder="ä¾‹å¦‚ï¼šå€Ÿé¤è²» / è½‰å¸³" />
          </div>
          <div class="btnrow">
            <button class="btn" data-close="modalQuickTx">å–æ¶ˆ</button>
            <button class="btn primary" id="saveQuickTx">æ–°å¢</button>
          </div>
          <div class="hint">
            è¦å‰‡ï¼š<span class="good">ä»–æ¬ æˆ‘ +</span> / <span class="bad">æˆ‘æ¬ ä»– -</span> / é‚„æ¬¾æœƒæŠŠæ¬ æ¬¾å¾€ 0 æ‹‰è¿‘ (à¸‡ â€¢Ì€_â€¢Ì)à¸‡
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const todayISO = () => {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };

  // Money: store in cents (integer) to avoid float issues
  const parseToCents = (s) => {
    if (typeof s !== 'string') s = String(s ?? '');
    s = s.trim().replace(/,/g,'');
    if (!s) return null;
    if (!/^\d+(\.\d{0,2})?$/.test(s)) return null;
    const [a,b=''] = s.split('.');
    const cents = Number(a) * 100 + Number((b + '00').slice(0,2));
    return Number.isFinite(cents) ? cents : null;
  };

  const centsToText = (cents) => {
    const sign = cents < 0 ? '-' : '';
    cents = Math.abs(cents);
    const a = Math.floor(cents / 100);
    const b = String(cents % 100).padStart(2, '0');
    return `${sign}NT$ ${a.toLocaleString('en-US')}.${b}`;
  };

  const fmtDate = (iso) => {
    if (!iso) return '';
    // show as YYYY/MM/DD
    const [y,m,d] = iso.split('-');
    return `${y}/${m}/${d}`;
  };

  const uid = (prefix='id') => `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;

  const toast = (msg) => {
    const el = $('#toast');
    el.textContent = msg;
    el.style.display = 'block';
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ el.style.display = 'none'; }, 1800);
  };

  // ---------- Storage ----------
  const KEY = 'iou_ledger_v1';
  const defaultState = () => ({
    contacts: [
      // demo-ish initial (optional). We'll keep empty to be clean.
    ],
    transactions: [],
    groups: []
  });

  const load = () => {
    try{
      const raw = localStorage.getItem(KEY);
      if (!raw) return defaultState();
      const s = JSON.parse(raw);
      if (!s || typeof s !== 'object') return defaultState();
      s.contacts = Array.isArray(s.contacts) ? s.contacts : [];
      s.transactions = Array.isArray(s.transactions) ? s.transactions : [];
      s.groups = Array.isArray(s.groups) ? s.groups : [];
      return s;
    }catch(e){
      return defaultState();
    }
  };

  const save = () => {
    localStorage.setItem(KEY, JSON.stringify(state));
  };

  // ---------- Domain logic ----------
  // balance is in cents
  const ensureContactByName = (name) => {
    name = String(name || '').trim();
    if (!name) return null;
    const existing = state.contacts.find(c => c.name === name);
    if (existing) return existing;
    const c = { id: uid('p'), name, balance: 0, createdAt: Date.now() };
    state.contacts.push(c);
    save();
    return c;
  };

  const getContact = (id) => state.contacts.find(c => c.id === id) || null;

  const adjustBalance = (personId, type, amountCents) => {
    const c = getContact(personId);
    if (!c) return;

    // balance > 0 : they owe you
    // type impact:
    // lend: +amount
    // borrow: -amount
    // repay_to_me: -amount
    // repay_by_me: +amount
    let delta = 0;
    switch(type){
      case 'lend': delta = +amountCents; break;
      case 'borrow': delta = -amountCents; break;
      case 'repay_to_me': delta = -amountCents; break;
      case 'repay_by_me': delta = +amountCents; break;
      default: delta = 0;
    }
    c.balance += delta;
  };

  const typeLabel = (type) => ({
    lend: 'ä»–æ¬ æˆ‘',
    borrow: 'æˆ‘æ¬ ä»–',
    repay_to_me: 'ä»–é‚„æˆ‘',
    repay_by_me: 'æˆ‘é‚„ä»–'
  }[type] || type);

  const typeEffectSign = (type) => (type === 'borrow' || type === 'repay_to_me') ? '-' : '+';

  const addTransaction = ({personId, type, amountCents, dateISO, note, groupId=null}) => {
    const tx = {
      id: uid('tx'),
      personId,
      type,
      amountCents,
      dateISO,
      note: note || '',
      groupId,
      createdAt: Date.now()
    };
    state.transactions.push(tx);
    adjustBalance(personId, type, amountCents);
    save();
    return tx;
  };

  const deleteTransaction = (txId) => {
    const idx = state.transactions.findIndex(t => t.id === txId);
    if (idx < 0) return false;
    const tx = state.transactions[idx];
    // reverse its effect on balance
    const c = getContact(tx.personId);
    if (c){
      // subtract the original delta
      adjustBalance(tx.personId, tx.type, -tx.amountCents);
    }
    state.transactions.splice(idx, 1);
    save();
    return true;
  };

  const upsertGroup = ({title, dateISO, note, members}) => {
    const total = members.reduce((s, m) => s + m.amountCents, 0);
    const g = {
      id: uid('g'),
      title: title || 'åˆ†å¸³',
      dateISO,
      note: note || '',
      totalCents: total,
      members: members.map(m => ({ personId: m.personId, amountCents: m.amountCents }))
    };
    state.groups.push(g);
    save();
    return g;
  };

  const sumOwedToMe = () => state.contacts
    .filter(c => c.balance > 0)
    .reduce((s,c)=>s+c.balance,0);

  const sumIOwe = () => state.contacts
    .filter(c => c.balance < 0)
    .reduce((s,c)=>s+Math.abs(c.balance),0);

  // ---------- UI State ----------
  let state = load();
  let currentView = 'dashboard'; // 'dashboard' | 'ledger'
  let currentPersonId = null;

  // ---------- Render ----------
  const renderDashboard = () => {
    $('#sumOwedToMe').textContent = centsToText(sumOwedToMe());
    $('#sumIOwe').textContent = centsToText(sumIOwe());

    const q = ($('#searchPeople').value || '').trim().toLowerCase();
    const list = $('#peopleList');
    list.innerHTML = '';

    const people = [...state.contacts]
      .sort((a,b) => Math.abs(b.balance) - Math.abs(a.balance) || (a.name.localeCompare(b.name,'zh-Hant')))
      .filter(c => !q || c.name.toLowerCase().includes(q));

    if (people.length === 0){
      const empty = document.createElement('div');
      empty.className = 'row';
      empty.style.cursor = 'default';
      empty.innerHTML = `
        <div class="name">
          <div>ç›®å‰é‚„æ²’æœ‰ä»»ä½•äºº</div>
          <div class="sub">æŒ‰å³ä¸‹è§’ã€Œï¼‹ã€æ–°å¢åˆ†å¸³ï¼Œæˆ–æŒ‰ã€Œï¼‹äººã€æ–°å¢äºº</div>
        </div>
        <div class="pill muted">(ãƒ»Ï‰ãƒ»)</div>
      `;
      list.appendChild(empty);
      return;
    }

    for (const p of people){
      const row = document.createElement('div');
      row.className = 'row';
      row.dataset.personId = p.id;

      const sub = p.balance === 0 ? 'å·²çµæ¸…' : (p.balance > 0 ? 'ä»–æ¬ ä½ ' : 'ä½ æ¬ ä»–');
      const pillClass = p.balance > 0 ? 'pill good' : (p.balance < 0 ? 'pill bad' : 'pill muted');

      row.innerHTML = `
        <div class="name">
          <div>${escapeHTML(p.name)}</div>
          <div class="sub">${sub}</div>
        </div>
        <div class="${pillClass}">${centsToText(p.balance)}</div>
      `;
      row.addEventListener('click', () => openLedger(p.id));
      list.appendChild(row);
    }
  };

  const renderLedger = (personId) => {
    const p = getContact(personId);
    if (!p) return;

    $('#ledgerName').textContent = p.name;
    const bal = p.balance;
    const balEl = $('#ledgerBalance');
    const text = bal === 0
      ? `å·²çµæ¸…ï¼š${centsToText(0)}`
      : (bal > 0 ? `ä»–æ¬ ä½ ï¼š${centsToText(bal)}` : `ä½ æ¬ ä»–ï¼š${centsToText(bal)}`);
    balEl.textContent = text;
    balEl.className = 'ledgerBalance ' + (bal > 0 ? 'good' : (bal < 0 ? 'bad' : ''));

    // tag info if you want
    const tag = $('#ledgerTag');
    tag.style.display = 'none';
    tag.textContent = '';

    const list = $('#txList');
    list.innerHTML = '';

    const txs = state.transactions
      .filter(t => t.personId === personId)
      .sort((a,b)=> (b.dateISO || '').localeCompare(a.dateISO || '') || b.createdAt - a.createdAt);

    if (txs.length === 0){
      const empty = document.createElement('div');
      empty.className = 'row';
      empty.style.cursor='default';
      empty.innerHTML = `
        <div class="name">
          <div>é‚„æ²’æœ‰æ˜ç´°</div>
          <div class="sub">ç”¨ä¸Šæ–¹æŒ‰éˆ•æ–°å¢ã€Œä»–æ¬ æˆ‘ / æˆ‘æ¬ ä»– / é‚„æ¬¾ã€</div>
        </div>
        <div class="pill muted">:)</div>
      `;
      list.appendChild(empty);
      return;
    }

    for (const t of txs){
      const amountSigned = (t.type === 'borrow' || t.type === 'repay_to_me') ? -t.amountCents : +t.amountCents;
      const amtClass = amountSigned >= 0 ? 'txAmt good' : 'txAmt bad';
      const amtText = (amountSigned >= 0 ? '+' : '-') + centsToText(Math.abs(amountSigned)).replace('NT$ ', 'NT$ ');

      const wrap = document.createElement('div');
      wrap.className = 'tx';

      const g = t.groupId ? state.groups.find(g=>g.id===t.groupId) : null;
      const metaParts = [
        fmtDate(t.dateISO),
        typeLabel(t.type)
      ];
      if (g) metaParts.push(`ç¾¤çµ„ï¼š${g.title}`);

      wrap.innerHTML = `
        <div class="txTop">
          <div class="txName">
            <div>${metaParts.join(' Â· ')}</div>
            <div class="txMeta">${t.id.slice(-6)}${t.groupId ? ` Â· ${t.groupId.slice(-6)}` : ''}</div>
          </div>
          <div class="${amtClass}">${amtText}</div>
        </div>
        ${t.note ? `<div class="txNote">å‚™è¨»ï¼š${escapeHTML(t.note)}</div>` : ''}
        <div class="txActions">
          <button class="tiny danger" data-del="${t.id}">åˆªé™¤</button>
        </div>
      `;

      wrap.querySelector('[data-del]')?.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿï¼ˆé¤˜é¡æœƒå›å¾©ï¼‰')) {
          deleteTransaction(t.id);
          toast('å·²åˆªé™¤');
          renderAll();
        }
      });

      list.appendChild(wrap);
    }
  };

  const renderAll = () => {
    if (currentView === 'dashboard'){
      $('#viewDashboard').style.display = '';
      $('#viewLedger').style.display = 'none';
      $('#navHome').classList.add('active');
      $('#navAdd').classList.remove('active');
      renderDashboard();
    } else {
      $('#viewDashboard').style.display = 'none';
      $('#viewLedger').style.display = '';
      $('#navHome').classList.remove('active');
      $('#navAdd').classList.remove('active');
      renderLedger(currentPersonId);
    }
    refreshQuickPersonOptions();
  };

  // ---------- Helpers ----------
  function escapeHTML(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  const openModal = (id) => { $('#'+id).style.display = 'flex'; };
  const closeModal = (id) => { $('#'+id).style.display = 'none'; };

  // ---------- Split Rows UI ----------
  const buildSplitRow = ({name='', amount=''}={}) => {
    const row = document.createElement('div');
    row.className = 'splitRow';
    row.innerHTML = `
      <div>
        <input class="input splitName" placeholder="äººåï¼ˆå¯æ–°å¢ï¼‰" value="${escapeHTML(name)}" />
      </div>
      <div>
        <input class="input splitAmt" inputmode="decimal" placeholder="é‡‘é¡" value="${escapeHTML(amount)}" />
      </div>
      <button class="smallbtn" title="åˆªé™¤">ğŸ—‘ï¸</button>
    `;
    row.querySelector('button').addEventListener('click', () => {
      row.remove();
      updateSplitTotal();
    });
    row.querySelector('.splitName').addEventListener('input', updateSplitTotal);
    row.querySelector('.splitAmt').addEventListener('input', updateSplitTotal);
    return row;
  };

  const updateSplitTotal = () => {
    const rows = $$('#splitTable .splitRow');
    let total = 0;
    for (const r of rows){
      const amt = parseToCents(r.querySelector('.splitAmt').value);
      if (amt !== null) total += amt;
    }
    $('#splitTotal').textContent = centsToText(total);
  };

  const initSplitForm = () => {
    $('#splitTitle').value = '';
    $('#splitDate').value = todayISO();
    $('#splitNote').value = '';
    const table = $('#splitTable');
    table.innerHTML = '';
    table.appendChild(buildSplitRow());
    table.appendChild(buildSplitRow());
    updateSplitTotal();
  };

  // ---------- Quick Tx UI ----------
  const refreshQuickPersonOptions = () => {
    const sel = $('#quickPerson');
    const current = sel.value;
    sel.innerHTML = '';

    const contacts = [...state.contacts].sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
    for (const c of contacts){
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name;
      sel.appendChild(opt);
    }
    if (contacts.length === 0){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'ï¼ˆè«‹å…ˆæ–°å¢äººï¼‰';
      sel.appendChild(opt);
    } else if (contacts.some(c=>c.id===current)){
      sel.value = current;
    }
  };

  const openQuickTx = ({personId=null, type='lend'}) => {
    refreshQuickPersonOptions();
    $('#quickDate').value = todayISO();
    $('#quickType').value = type;
    $('#quickAmount').value = '';
    $('#quickNote').value = '';

    if (personId){
      $('#quickPerson').value = personId;
      const p = getContact(personId);
      $('#quickTitle').textContent = `æ–°å¢ç´€éŒ„ï¼š${p ? p.name : ''}`;
    } else {
      $('#quickTitle').textContent = 'æ–°å¢ç´€éŒ„';
    }

    openModal('modalQuickTx');
  };

  // ---------- Navigation ----------
  const openDashboard = () => {
    currentView = 'dashboard';
    currentPersonId = null;
    renderAll();
  };

  const openLedger = (personId) => {
    currentView = 'ledger';
    currentPersonId = personId;
    renderAll();
  };

  // ---------- Events ----------
  $('#searchPeople').addEventListener('input', renderDashboard);

  $('#btnAddPerson').addEventListener('click', () => {
    $('#personName').value = '';
    openModal('modalPerson');
    setTimeout(()=>$('#personName').focus(), 50);
  });

  $('#savePerson').addEventListener('click', () => {
    const name = ($('#personName').value || '').trim();
    if (!name) return toast('äººåä¸èƒ½ç©º (ãƒ»Ï‰ãƒ»)');
    ensureContactByName(name);
    closeModal('modalPerson');
    toast('å·²æ–°å¢');
    renderAll();
  });

  $('#fab').addEventListener('click', () => {
    // If on ledger, still allow split (group) by default.
    initSplitForm();
    openModal('modalSplit');
  });

  $('#navHome').addEventListener('click', openDashboard);

  $('#navAdd').addEventListener('click', () => {
    initSplitForm();
    openModal('modalSplit');
  });

  // close modals
  $$('[data-close]').forEach(btn => {
    btn.addEventListener('click', () => closeModal(btn.dataset.close));
  });
  // click overlay to close
  ['modalPerson','modalSplit','modalQuickTx'].forEach(id => {
    $('#'+id).addEventListener('click', (e) => {
      if (e.target.id === id) closeModal(id);
    });
  });

  // Split rows actions
  $('#addSplitRow').addEventListener('click', () => {
    $('#splitTable').appendChild(buildSplitRow());
    updateSplitTotal();
  });
  $('#add3Rows').addEventListener('click', () => {
    const table = $('#splitTable');
    table.appendChild(buildSplitRow());
    table.appendChild(buildSplitRow());
    table.appendChild(buildSplitRow());
    updateSplitTotal();
  });

  $('#saveSplit').addEventListener('click', () => {
    const title = ($('#splitTitle').value || '').trim() || 'åˆ†å¸³';
    const dateISO = $('#splitDate').value || todayISO();
    const note = ($('#splitNote').value || '').trim();

    const rows = $$('#splitTable .splitRow');
    if (rows.length === 0) return toast('è‡³å°‘è¦ä¸€åˆ—åˆ†å¸³ (ï¼›Â´Ğ´ï½€)');

    const members = [];
    for (const r of rows){
      const name = (r.querySelector('.splitName').value || '').trim();
      const amtStr = r.querySelector('.splitAmt').value;
      const amt = parseToCents(amtStr);
      if (!name && (amtStr || '').trim()) return toast('æœ‰äººé‡‘é¡æœ‰å¡«ï¼Œä½†äººåç©ºäº† (à®‡ï¹à®‡)');
      if (name && amt === null) return toast(`ã€Œ${name}ã€é‡‘é¡æ ¼å¼ä¸å°ï¼ˆæœ€å¤šå…©ä½å°æ•¸ï¼‰`);
      if (name && amt !== null){
        if (amt <= 0) return toast(`ã€Œ${name}ã€é‡‘é¡è¦ > 0`);
        const c = ensureContactByName(name);
        members.push({ personId: c.id, amountCents: amt });
      }
    }

    if (members.length === 0) return toast('ä½ é‚„æ²’å¡«ä»»ä½•æœ‰æ•ˆçš„åˆ†å¸³åˆ— (ãƒ»_ãƒ»;)');

    // Create group
    const g = upsertGroup({ title, dateISO, note, members });

    // Create transactions as lend only: they owe you
    for (const m of members){
      addTransaction({
        personId: m.personId,
        type: 'lend',
        amountCents: m.amountCents,
        dateISO,
        note: note ? `${title}ï½œ${note}` : title,
        groupId: g.id
      });
    }

    closeModal('modalSplit');
    toast('åˆ†å¸³å·²æ–°å¢ âœ…');
    renderAll();
  });

  // Ledger controls
  $('#btnBack').addEventListener('click', openDashboard);

  $('#btnQuickLend').addEventListener('click', ()=> openQuickTx({personId: currentPersonId, type:'lend'}));
  $('#btnQuickBorrow').addEventListener('click', ()=> openQuickTx({personId: currentPersonId, type:'borrow'}));
  $('#btnQuickRepayToMe').addEventListener('click', ()=> openQuickTx({personId: currentPersonId, type:'repay_to_me'}));
  $('#btnQuickRepayByMe').addEventListener('click', ()=> openQuickTx({personId: currentPersonId, type:'repay_by_me'}));

  $('#saveQuickTx').addEventListener('click', () => {
    const personId = $('#quickPerson').value;
    if (!personId) return toast('è«‹å…ˆæ–°å¢äºº (ãƒ»Ï‰ãƒ»)');
    const type = $('#quickType').value;
    const dateISO = $('#quickDate').value || todayISO();
    const amountCents = parseToCents($('#quickAmount').value);
    const note = ($('#quickNote').value || '').trim();

    if (amountCents === null) return toast('é‡‘é¡æ ¼å¼ä¸å°ï¼ˆæœ€å¤šå…©ä½å°æ•¸ï¼‰');
    if (amountCents <= 0) return toast('é‡‘é¡è¦ > 0');
    addTransaction({ personId, type, amountCents, dateISO, note });

    closeModal('modalQuickTx');
    toast('å·²æ–°å¢ç´€éŒ„ âœ¨');
    if (currentView === 'ledger') renderAll();
    else renderAll();
  });

  // Reset
  $('#btnReset').addEventListener('click', () => {
    if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰')) return;
    localStorage.removeItem(KEY);
    state = load();
    toast('å·²é‡ç½®');
    openDashboard();
  });

  // initial
  $('#splitDate').value = todayISO();
  $('#quickDate').value = todayISO();
  renderAll();

  // Make dashboard list clickable even after data changes
})();
</script>
</body>
</html>
